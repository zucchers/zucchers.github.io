#!/bin/bash

#-----------------------------------------------------------------------------#
# Cleans up all files older than 10 minutes
# Get current date
NOW="$(date '+%Y%m%d%H%M%S%N')"
CURRENT=${NOW:0:4}'-'${NOW:4:2}'-'${NOW:6:2}' '${NOW:8:2}':'${NOW:10:2}':'${NOW:12:2}
CURRENT=$(date +%s -d "$CURRENT")
ls verifica*pdf | sed 's/verifica//g' | sed 's/.pdf//g' |
while read TMP
do
  TARGET=${TMP:0:4}'-'${TMP:4:2}'-'${TMP:6:2}' '${TMP:8:2}':'${TMP:10:2}':'${TMP:12:2}
  TARGET=$(date +%s -d "$TARGET")
  # Compute time difference in minutes
  MINUTES=$(( ($CURRENT - $TARGET ) / 60 ))
  # Check time diffence and possibly delete old files
  if [ $MINUTES -gt "1" ]; then
     fname=verifica$TMP.pdf
     rm -f $fname
  fi
done
#-----------------------------------------------------------------------------#

# A temporary file
TMP_FILE="mklatextmpfile$(date '+%Y%m%d%H%M%S%N')"

# Basename and latex file
BASE=`basename "$1" .in`
TEX_FILE=$BASE.tex

# Remove comments ('#') and empty lines
#### ATTENZIONE: ^M si scrive CTRL-V CTRL-M ####
cat $1 | sed 's/ESERCIZI:/ESERCIZI:\n/g' | sed -e 's//\n/g'  \
       | sed 's/\#/\n\#/g' | sed '/^\#/d' \
       | sed '/^$/d' > $TMP_FILE
# Get data from input file
SOURCEDIR="$(cat $TMP_FILE | grep SOURCEDIR | sed 's/ //g' \
        | sed 's/SOURCEDIR://')"
CLASSE="$(cat $TMP_FILE | grep CLASSE | sed 's/ //g' | sed 's/CLASSE://'\
        | sed 's/ //')"
DATA="$(cat $TMP_FILE | grep DATA | sed 's/DATA://')"
TITOLO="$(cat $TMP_FILE | grep TITOLO | sed 's/TITOLO://')"
LUI="$(cat $TMP_FILE | grep LUI | sed 's/LUI://' | sed 's/ //')"
LEI="$(cat $TMP_FILE | grep LEI | sed 's/LEI://' | sed 's/ //')"


# Figure out the line where the list of excercises starts
EX_L="$(grep -n -o ESERCIZI: $TMP_FILE | sed s/:ESERCIZI:// )"
# Figure out the number of lines of tmp file
N_LINES="$(wc -l < $TMP_FILE)"

echo '%----------------------------------------------------------------------%'\
      > $TEX_FILE
echo % file $TEX_FILE was generated by $0 on $(date '+%Y-%m-%d at %H:%M:%S')\
      >> $TEX_FILE
echo % input file: $1 >> $TEX_FILE
echo '%----------------------------------------------------------------------%'\
      >> $TEX_FILE
echo '\documentclass[a4paper,12pt,italian]{article}' >> $TEX_FILE
echo '\setlength{\topmargin}{-25 mm}' >> $TEX_FILE
echo '\setlength{\oddsidemargin}{-18 mm}' >> $TEX_FILE
echo '\setlength{\textwidth}{190 mm}' >> $TEX_FILE
echo '\setlength{\textheight}{267 mm}' >> $TEX_FILE
#echo '\usepackage{babel,amsmath,amsfonts,graphics,graphicx,upgreek}'>> $TEX_FILE
echo '\usepackage{amsmath,amsfonts,graphics,graphicx,upgreek}'>> $TEX_FILE
echo '\usepackage[none]{hyphenat} '>> $TEX_FILE
echo '\usepackage{pst-all,pstricks-add}' >> $TEX_FILE
echo '\newgray{mygray}{0.85}\newgray{mygrayI}{0.95}' >> $TEX_FILE

echo '%----------------------------------------------------------------------%'\
      >> $TEX_FILE
echo \\newcommand{\\SOURCEDIR}{${SOURCEDIR}} >> $TEX_FILE
echo \\newcommand{\\CLASSE}{${CLASSE}} >> $TEX_FILE
echo \\newcommand{\\LUI}{${LUI}} >> $TEX_FILE
echo \\newcommand{\\LEI}{${LEI}} >> $TEX_FILE
cat "${SOURCEDIR}/latexdef.tex" >> $TEX_FILE
echo '%----------------------------------------------------------------------%'\
     >> $TEX_FILE
echo '\pagestyle{empty}' >> $TEX_FILE
echo '\begin{document}' >> $TEX_FILE
echo '\begin{center}' >> $TEX_FILE
echo {\\Large \\textbf{$TITOLO}}\\\\[2ex] >> $TEX_FILE
echo Classe \\CLASSE, $DATA >> $TEX_FILE
echo '\end{center}' >> $TEX_FILE
#echo '\vspace{-3mm}' >> $TEX_FILE
echo '\begin{enumerate}' >> $TEX_FILE
#------------------------------------------------------------------------------#
echo $ENDNAME
tail -`expr $N_LINES - $EX_L` $TMP_FILE |
while read line
do
  echo '\item ' >> $TEX_FILE
  cat "${SOURCEDIR}/${line}t.tex" >> $TEX_FILE
done
#------------------------------------------------------------------------------#
echo '\end{enumerate}' >> $TEX_FILE
echo '\newpage' >> $TEX_FILE
echo '%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%' >> $TEX_FILE
echo '%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%' >> $TEX_FILE
echo '%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%' >> $TEX_FILE
echo '{\bf Risoluzione}' >> $TEX_FILE
echo '\pagestyle{plain}' >> $TEX_FILE
echo '\begin{enumerate}' >> $TEX_FILE
#------------------------------------------------------------------------------#
tail -`expr $N_LINES - $EX_L` $TMP_FILE | 
while read line
do
  echo '\item Codice esercizio: {\bf '${line}'}\\' >> $TEX_FILE
  cat "${SOURCEDIR}/${line}s.tex" >> $TEX_FILE
done
#------------------------------------------------------------------------------#
echo '\end{enumerate}' >> $TEX_FILE
echo '\end{document}' >> $TEX_FILE

# Remove difficulties
cat $TEX_FILE | sed 's/\\newcommand{\\diff/\\newcommand{\\DIFF/g' \
              | sed 's/\\difftre//g' | sed 's/\\diffdue//g'\
              | sed 's/\\diffuno//g'| sed 's/\\diffnul//g' \
	      | sed '/^$/d' > $TMP_FILE
mv $TMP_FILE $TEX_FILE

# Generate latex file without path for figures
cat $TEX_FILE | sed 's/\\SOURCEDIR\/FIGURE\///' > $TMP_FILE
mv $TMP_FILE $TEX_FILE

#------------------------------------------------------------------------------#
# Generate exectutable file $GO_FILE to run latex remotely
rm -f $GO_FILE
# Generate list of figures
figlist="$(cat $TEX_FILE | grep includegraphics | \
   egrep -o '\{.*\}' | tr -d }{)"
GO_FILE=go$BASE.sh
#echo 'cp '${SOURCEDIR}'/FIGURE/*.eps .' > $GO_FILE
echo 'cp '${SOURCEDIR}'/*.eps .' > $GO_FILE
echo './laton '$TEX_FILE' '$figlist >> $GO_FILE
echo 'rm -f *.eps' >> $GO_FILE
echo 'chmod +r '$BASE'.pdf' >> $GO_FILE
echo '' >> $GO_FILE
chmod +x $GO_FILE
#------------------------------------------------------------------------------#


# Clean temporary files
rm -f $TMP_FILE #$BASE.aux $BASE.log $BASE.ps #$BASE.tex  $BASE.dvi
